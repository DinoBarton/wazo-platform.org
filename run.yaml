---
- hosts: all
  tasks:
    - name: Prepare config.js
      copy:
        content: |
          module.exports = {
            githubToken: '',
            algolia: {
              appId: '',
              publicKey: '',
              apiKey: '',
            },
          };
        dest: "{{ zuul.project.src_dir }}/config.js"

    - name: make
      command: "make"
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: make build
      command: "make build"
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: Display available ssh keys
      shell: "ssh-add -l || :"

    - name: Push the public directory to the web site
      shell: 'rsync -e "ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no  -o PreferredAuthentications=publickey" -avz --delete public/ zuul-publisher@webserver.wazo.community:'
      args:
        chdir: "{{ zuul.project.src_dir }}"
